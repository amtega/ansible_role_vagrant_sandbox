---
# Vagrant provision tasks

- block:
    - name: provisione vagrant sandbox environment
      include_role:
        name: amtega.vagrant_provisioner
      vars:
        vagrant_provisioner_boxes: >-
          {{ (vagrant_sandbox_state in ["absent", "recreated"])
             | ternary([], vagrant_sandbox_boxes) }}
        vagrant_provisioner_box_state: present
        vagrant_provisioner_vms: "{{ vagrant_sandbox_vms }}"
        vagrant_provisioner_vms_directory: "{{ vagrant_sandbox_vms_directory }}"
        vagrant_provisioner_vm_groups: ["{{ vagrant_sandbox_group }}"]
        vagrant_provisioner_inventory: >-
         {{ (vagrant_sandbox_state in ["started", "recreated"])
             | ternary(vagrant_sandbox_inventory, "") }}
        vagrant_provisioner_vm_state: >-
           {{ (vagrant_sandbox_state in ["recreated"])
              | ternary("started", vagrant_sandbox_state) }}

    - name: create vagrant sanbox state files
      template:
        src: sandbox.ini.j2
        dest: >-
          {{ hostvars[vm.hostname]['vagrant_provisioner_vm_directory']
             + "/sandbox.ini" }}
        force: yes
      register: vagrant_provisioner_create_vagrantfile_result
      with_items: "{{ vagrant_sandbox_vms }}"
      loop_control:
        loop_var: "vm"
        label: "{{ vm.name }}"
      vars:
        ppid: >-
          {{ lookup('pipe', 'ps -o ppid= -p `ps -o ppid= -p $PPID`') | trim }}
        user: >-
          {{ lookup('pipe', 'echo $USER') | trim }}
        playbook: "{{ vagrant_sandbox_playbook }}"
        inventory: "{{ vagrant_sandbox_inventory }}"

  tags:
    - role::vagrant_sandbox
    - role::vagrant_sandbox::provision
